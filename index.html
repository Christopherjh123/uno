<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>UNO Online</title>
  <style>
    body { font-family: system-ui, sans-serif; background: #2f3542; color: #f1f2f6; margin: 0; }
    header { padding: 1em; text-align: center; background: #57606f; }
    main { max-width: 900px; margin: 2em auto; background: #374151; padding: 2em; border-radius: 1em; box-shadow: 0 2px 12px #1118; }
    textarea { width: 100%; font-size: 1em; }
    .hidden { display: none; }
    #signaling { margin: 2em 0; }
    #status { margin-top: 1em; }
    .player { margin: 1em 0; }
    .hand { display: flex; gap: 0.4em; margin-top: 0.3em; flex-wrap: wrap; }
    .card {
      min-width: 60px; min-height: 80px; font-weight: bold; font-size: 1.3em; text-align: center;
      line-height: 76px; border-radius: 12px; border: 2px solid #444; cursor: pointer; box-shadow: 1px 2px 3px #1119;
      background: #ced6e0; color: #222; position: relative; transition: transform .08s;
    }
    .card.red { background: #ff6b81; color: #fff; border-color: #b71c1c; }
    .card.green { background: #2ed573; color: #fff; border-color: #006400; }
    .card.blue { background: #1e90ff; color: #fff; border-color: #003366; }
    .card.yellow { background: #ffe066; color: #555; border-color: #b7950b; }
    .card.wild { background: linear-gradient(135deg, #fff 55%, #2ed573 55%, #2ed573 65%, #1e90ff 65%, #1e90ff 75%, #ffe066 75%, #ffe066 85%, #ff6b81 85%); color: #111; border-color: #000; }
    .card:hover { transform: scale(1.08); filter: brightness(1.1);}
    #discard, #draw { min-width: 60px; min-height: 80px; display: inline-block; vertical-align: middle; }
    .controls { margin: 1em 0; }
    #draw { background: #636e72; color: #fff; border: 2px solid #222; border-radius: 12px; line-height: 76px; text-align: center; cursor: pointer; }
    #discard { margin-right: 1em; }
    .turn { font-weight: bold; color: #ffe066; }
    #unoBtn { margin-left: 1em; background: #ff6b81; color: #fff; border: none; padding: 0.5em 1.2em; border-radius: 6px; font-size: 1.1em;}
    .uno-warn { color: #ff6b81; font-weight: bold; }
    .log { background: #23272f; color: #e1e3e7; border-radius: 8px; padding: 0.6em; height: 6em; overflow: auto; font-size: 0.97em; }
    .gameover { color: #ffe066; font-size: 1.3em; font-weight: bold;}
    @media (max-width: 700px) { main { padding: 0.7em; } }
  </style>
</head>
<body>
<header>
  <h1>UNO Online</h1>
  <div style="font-size:1em;">Peer-to-peer, all in one UNO! Play with a friend anywhere!</div>
</header>
<main>
  <section id="connect">
    <button id="btnHost">Host Game</button>
    <button id="btnJoin">Join Game</button>
    <div id="signaling" class="hidden">
      <h3>Step 1: Copy this code and send it to your friend</h3>
      <textarea id="localSignal" readonly></textarea>
      <h3>Step 2: Paste their code below and click Connect</h3>
      <textarea id="remoteSignal"></textarea>
      <button id="btnSignalConnect">Connect</button>
      <div id="status"></div>
    </div>
  </section>

  <section id="game" class="hidden">
    <div class="controls">
      <span id="turnInfo"></span>
      <span id="unoWarn" class="uno-warn"></span>
      <button id="unoBtn" class="hidden">UNO!</button>
    </div>
    <div style="margin-bottom:1em;">
      <span id="discard"></span>
      <span id="draw" title="Draw Pile">ðŸ‚ <br>Draw</span>
      <span id="drawCount"></span>
    </div>
    <div class="player">
      <h3>You (<span id="myName"></span>): <span id="myCardCount"></span> cards</h3>
      <div id="myHand" class="hand"></div>
    </div>
    <div class="player">
      <h3>Opponent (<span id="oppName"></span>): <span id="oppCardCount"></span> cards</h3>
      <div id="oppHand" class="hand"></div>
    </div>
    <div class="log" id="log"></div>
    <div class="gameover hidden" id="gameover"></div>
  </section>
</main>
<script>
// --- GAME CONSTANTS ---
const COLORS = ['red', 'green', 'blue', 'yellow'];
const VALUES = ['0','1','2','3','4','5','6','7','8','9','Skip','Reverse','Draw2'];
const WILD = ['Wild','Wild+4'];
const FULL_DECK = () => {
  let d = [];
  for(let c of COLORS) {
    d.push({color:c, value:'0'});
    for(let v of VALUES.slice(1)) d.push({color:c, value:v}, {color:c, value:v});
    d.push({color:c, value:'Skip'}, {color:c, value:'Skip'});
    d.push({color:c, value:'Reverse'}, {color:c, value:'Reverse'});
    d.push({color:c, value:'Draw2'}, {color:c, value:'Draw2'});
  }
  for(let i=0; i<4; ++i) d.push({color:'wild', value:'Wild'}), d.push({color:'wild', value:'Wild+4'});
  return shuffle([...d]);
};
function shuffle(a) {
  for(let i=a.length-1; i>0; --i) {
    let j = Math.floor(Math.random()*(i+1)); [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}
function cardToString(card) {
  if(card.color==='wild') return card.value;
  return card.color.charAt(0).toUpperCase() + card.color.slice(1) + ' ' + card.value;
}
function canPlay(card, top, currentColor) {
  if(card.color==='wild') return true;
  if(card.color===currentColor) return true;
  if(card.value===top.value) return true;
  return false;
}

// --- PEER CONNECTION SETUP ---
let pc, dc, isHost, isConnected=false;
let myName = 'You', oppName = 'Opponent';

function log(msg, color='') {
  let logBox = document.getElementById("log");
  logBox.innerHTML += (color ? `<span style="color:${color}">${msg}</span>` : msg) + "<br>";
  logBox.scrollTop = logBox.scrollHeight;
}

function setupPeer(initiator) {
  pc = new RTCPeerConnection();
  if(initiator) {
    dc = pc.createDataChannel("game");
    setupDataChannel(dc);
  } else {
    pc.ondatachannel = e => {
      dc = e.channel;
      setupDataChannel(dc);
    };
  }
  pc.onicecandidate = e => {
    if(e.candidate) return;
    document.getElementById('localSignal').value = btoa(JSON.stringify(pc.localDescription));
  };
}

function setupDataChannel(channel) {
  channel.onopen = () => {
    isConnected = true;
    document.getElementById("game").classList.remove("hidden");
    document.getElementById("connect").classList.add("hidden");
    startGame();
  };
  channel.onmessage = e => receiveMsg(JSON.parse(e.data));
}

function sendMsg(obj) {
  if(dc && dc.readyState==='open') dc.send(JSON.stringify(obj));
}

document.getElementById("btnHost").onclick = async () => {
  isHost = true; myName='Host'; oppName='Guest';
  updateNames();
  setupPeer(true);
  let offer = await pc.createOffer(); await pc.setLocalDescription(offer);
  document.getElementById("signaling").classList.remove("hidden");
};
document.getElementById("btnJoin").onclick = () => {
  isHost = false; myName='Guest'; oppName='Host';
  updateNames();
  setupPeer(false);
  document.getElementById("signaling").classList.remove("hidden");
};
document.getElementById("btnSignalConnect").onclick = async () => {
  let remote = JSON.parse(atob(document.getElementById("remoteSignal").value.trim()));
  await pc.setRemoteDescription(remote);
  if(remote.type==='offer') {
    let ans = await pc.createAnswer(); await pc.setLocalDescription(ans);
  }
  document.getElementById("status").textContent = "Send this code to the other player:";
  document.getElementById("localSignal").value = btoa(JSON.stringify(pc.localDescription));
};

// --- UNO GAME LOGIC ---
let deck = [], hands = [[],[]], discard = [], drawCount=0, turn=0, dir=1, currentColor='', pendingDraw=0, winner=-1, unoSaid=[false,false], skipNext=false, mustCallUno=[false,false];
function startGame() {
  deck = FULL_DECK(); discard = []; hands = [[],[]]; drawCount=0; turn=0; dir=1; winner=-1; unoSaid=[false,false]; mustCallUno=[false,false]; skipNext=false; pendingDraw=0;

  // Deal 7 cards to each
  for(let i=0;i<7;i++) hands[0].push(deck.pop()), hands[1].push(deck.pop());
  // Place starting card, not wild/draw
  let first;
  do { first = deck.pop(); } while(first.color==='wild' || first.value==='Skip' || first.value==='Reverse' || first.value==='Draw2');
  discard.push(first);
  currentColor = first.color;
  // Host starts
  updateUI();
  if(isHost) {
    sendMsg({type:'init', hand: hands[1], discard, currentColor, turn, dir});
  }
  log("Game started! " + (turn==playerId() ? "Your turn." : "Waiting for opponent..."), "#ffe066");
}
function receiveMsg(msg) {
  if(msg.type==='init') {
    hands[0]=msg.hand; discard=msg.discard; currentColor=msg.currentColor; turn=msg.turn; dir=msg.dir;
    updateUI();
    log("Game started! " + (turn==playerId() ? "Your turn." : "Waiting for opponent..."), "#ffe066");
  }
  if(msg.type==='play') {
    let pid = 1-playerId();
    let card = msg.card, color = msg.color;
    discard.push(card);
    currentColor = color;
    hands[pid].splice(msg.idx,1);
    unoSaid[pid] = msg.uno || false;
    mustCallUno[pid] = hands[pid].length==1;
    log(`${oppName} played: <b>${cardToString(card)}</b> ${card.color==='wild'?'('+color+')':''}`, "#80ffbf");
    handleCardEffect(card, false);
    checkUnoCall();
    if(hands[pid].length===0) { endGame(oppName); }
    else updateTurn();
    updateUI();
  }
  if(msg.type==='draw') {
    let pid = 1-playerId();
    for(let c of msg.cards) hands[pid].push(c);
    mustCallUno[pid] = hands[pid].length==1;
    unoSaid[pid] = false;
    log(`${oppName} drew ${msg.cards.length} card(s).`, "#a4b0be");
    if(msg.skip) updateTurn();
    updateUI();
  }
  if(msg.type==='uno') {
    unoSaid[1-playerId()] = true;
    log(`${oppName} called UNO!`, "#ffe066");
    updateUI();
  }
  if(msg.type==='uno-missed') {
    let pid = 1-playerId();
    let penalty = msg.penalty;
    log(`${oppName} missed UNO! +${penalty} penalty card(s).`, "#ff6b81");
    updateUI();
  }
}
function playerId() { return isHost?0:1; }
function updateNames() {
  document.getElementById("myName").textContent = myName;
  document.getElementById("oppName").textContent = oppName;
}
function updateUI() {
  // Card counts
  document.getElementById("myCardCount").textContent = hands[playerId()]?hands[playerId()].length:0;
  document.getElementById("oppCardCount").textContent = hands[1-playerId()]?hands[1-playerId()].length:0;
  // Discard
  let top = discard[discard.length-1];
  document.getElementById("discard").innerHTML = renderCard(top);
  document.getElementById("discard").title = cardToString(top) + (top.color==='wild'?' ('+currentColor+')':'');
  // Draw pile
  document.getElementById("drawCount").textContent = `(${deck.length} left)`;
  // My hand
  let mh = document.getElementById("myHand"), oh = document.getElementById("oppHand");
  mh.innerHTML = ''; oh.innerHTML = '';
  hands[playerId()] && hands[playerId()].forEach((card,i) => {
    let el = document.createElement("div");
    el.className = "card " + card.color;
    el.innerHTML = card.value;
    el.title = cardToString(card);
    if(turn===playerId() && canPlay(card, discard[discard.length-1], currentColor) && winner==-1 && pendingDraw===0)
      el.onclick = () => playCard(i);
    else el.style.opacity = '0.7';
    mh.appendChild(el);
  });
  // Opponent hand (show card backs)
  hands[1-playerId()] && hands[1-playerId()].forEach((c,i) => {
    let el = document.createElement("div");
    el.className = "card"; el.style.background="#222"; el.style.color="#222"; el.textContent='ðŸ‚ ';
    oh.appendChild(el);
  });
  // Turn info
  let tinfo = document.getElementById("turnInfo");
  tinfo.innerHTML = turn===playerId() ? "<span class='turn'>Your turn!</span>" : `Waiting for ${oppName}...`;
  // UNO button
  let unoBtn = document.getElementById("unoBtn");
  if(hands[playerId()] && hands[playerId()].length===2 && turn===playerId() && !unoSaid[playerId()]) {
    unoBtn.classList.remove("hidden");
  } else unoBtn.classList.add("hidden");
  // Uno warning
  let unoWarn = document.getElementById("unoWarn");
  if(mustCallUno[playerId()] && !unoSaid[playerId()] && turn===playerId()) {
    unoWarn.textContent = "Don't forget to call UNO!";
  } else unoWarn.textContent = "";
  // Gameover
  if(winner!=-1) {
    document.getElementById("gameover").classList.remove('hidden');
    document.getElementById("gameover").textContent = winner===playerId() ? "You win! ðŸŽ‰" : oppName+" wins!";
  } else {
    document.getElementById("gameover").classList.add('hidden');
  }
}
function renderCard(card) {
  let c = document.createElement("span");
  c.className = "card "+card.color;
  c.innerHTML = card.value;
  return c.outerHTML;
}
function playCard(idx) {
  if(turn!==playerId() || winner!=-1) return;
  let card = hands[playerId()][idx];
  if(!canPlay(card, discard[discard.length-1], currentColor) || pendingDraw>0) return;
  // Wild: choose color
  let chosenColor = card.color;
  if(card.color==='wild') {
    chosenColor = prompt("Choose color: red, green, blue, yellow", COLORS[0]);
    if(!COLORS.includes(chosenColor)) chosenColor = COLORS[0];
  }
  // Remove card from hand
  hands[playerId()].splice(idx,1);
  discard.push(card);
  currentColor = chosenColor;
  // UNO call?
  let uno = false;
  if(hands[playerId()].length===1 && !unoSaid[playerId()]) mustCallUno[playerId()]=true;
  if(hands[playerId()].length===1 && hands[playerId()].length<3) {
    if(confirm("Call UNO?")) {
      uno = true;
      unoSaid[playerId()] = true;
      sendMsg({type:'uno'});
      log("You called UNO!","#ffe066");
    }
  }
  sendMsg({type:'play', card, color:chosenColor, idx, uno});
  log(`You played: <b>${cardToString(card)}</b> ${card.color==='wild'?'('+chosenColor+')':''}`, "#70a1ff");
  handleCardEffect(card, true);
  checkUnoCall();
  if(hands[playerId()].length===0) { endGame(myName); }
  else updateTurn();
  updateUI();
}
function handleCardEffect(card, isMe) {
  pendingDraw = 0;
  if(card.value==='Skip') { skipNext=true; }
  if(card.value==='Reverse') { dir*=-1; if(hands[0].length>1||hands[1].length>1) if(hands.length==2) skipNext=true; }
  if(card.value==='Draw2') { pendingDraw=2; }
  if(card.value==='Wild+4') { pendingDraw=4; }
}
function checkUnoCall() {
  // If player has 1 card and didn't call UNO, opponent can call out!
  for(let pid=0;pid<=1;pid++) {
    if(hands[pid].length===1 && !unoSaid[pid] && mustCallUno[pid]) {
      if(pid===playerId()) {
        // Give a chance to call UNO before play continues (button!)
        setTimeout(()=>{
          if(!unoSaid[pid]) {
            let penalty = 2;
            for(let i=0;i<penalty;i++) hands[pid].push(deck.pop());
            log("You missed UNO! You draw 2 penalty cards.","#ff6b81");
            sendMsg({type:'uno-missed', penalty});
            mustCallUno[pid]=false;
            updateUI();
          }
        }, 2000);
      } else {
        // Opponent missed, we can call them out!
        setTimeout(()=>{
          if(!unoSaid[pid]) {
            let penalty = 2;
            for(let i=0;i<penalty;i++) hands[pid].push(deck.pop());
            log(`${oppName} missed UNO! +2 penalty cards.`, "#ff6b81");
            sendMsg({type:'uno-missed', penalty});
            mustCallUno[pid]=false;
            updateUI();
          }
        }, 2000);
      }
    }
  }
}
document.getElementById("unoBtn").onclick = () => {
  unoSaid[playerId()] = true;
  mustCallUno[playerId()] = false;
  sendMsg({type:'uno'});
  log("You called UNO!", "#ffe066");
  updateUI();
};
function updateTurn() {
  if(skipNext) { turn=(turn+dir+2)%2; skipNext=false; }
  else turn=(turn+dir+2)%2;
  unoSaid = [false,false];
}
function endGame(who) {
  winner = who===myName?playerId():1-playerId();
  updateUI();
  log(`${who} wins the game!`,"#ffe066");
}
document.getElementById("draw").onclick = () => {
  if(turn!==playerId() || winner!=-1) return;
  let n = pendingDraw || 1;
  let drawn = [];
  for(let i=0;i<n;i++) {
    if(deck.length===0) reshuffle();
    drawn.push(deck.pop());
  }
  hands[playerId()].push(...drawn);
  sendMsg({type:'draw', cards:drawn, skip:pendingDraw>0});
  log(`You drew ${drawn.length} card(s).`, "#a4b0be");
  pendingDraw=0;
  if(n>1||drawn.every(card=>!canPlay(card, discard[discard.length-1], currentColor))) updateTurn();
  updateUI();
};
function reshuffle() {
  let save = discard.pop();
  deck = shuffle(discard);
  discard = [save];
}
</script>
</body>
</html>
